<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export/Import D·ªØ Li·ªáu - Th·∫ø Gi·ªõi Di ƒê·ªông</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f5f5f5; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stats-card { background: linear-gradient(135deg, #0066cc, #004499); color: white; }
        .btn-export { background: #28a745; border: none; }
        .btn-import { background: #0066cc; border: none; }
        .data-preview { max-height: 300px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; font-family: monospace; font-size: 12px; }
        .key-badge { font-size: 11px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark" style="background: #0066cc;">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-mobile-alt me-2"></i>Th·∫ø Gi·ªõi Di ƒê·ªông
            </a>
            <a href="admin.html" class="btn btn-outline-light btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Quay l·∫°i Admin
            </a>
        </div>
    </nav>

    <div class="container py-4">
        <h2 class="mb-4"><i class="fas fa-database me-2"></i>Export/Import D·ªØ Li·ªáu LocalStorage</h2>
        
        <!-- Th·ªëng k√™ -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card stats-card">
                    <div class="card-body">
                        <h5><i class="fas fa-chart-bar me-2"></i>Th·ªëng k√™ d·ªØ li·ªáu hi·ªán t·∫°i</h5>
                        <div class="row mt-3" id="statsContainer">
                            <div class="col text-center">
                                <div class="fs-3 fw-bold" id="statProducts">0</div>
                                <small>S·∫£n ph·∫©m</small>
                            </div>
                            <div class="col text-center">
                                <div class="fs-3 fw-bold" id="statAccessories">0</div>
                                <small>Ph·ª• ki·ªán</small>
                            </div>
                            <div class="col text-center">
                                <div class="fs-3 fw-bold" id="statOrders">0</div>
                                <small>ƒê∆°n h√†ng</small>
                            </div>
                            <div class="col text-center">
                                <div class="fs-3 fw-bold" id="statUsers">0</div>
                                <small>Users</small>
                            </div>
                            <div class="col text-center">
                                <div class="fs-3 fw-bold" id="statReviews">0</div>
                                <small>ƒê√°nh gi√°</small>
                            </div>
                            <div class="col text-center">
                                <div class="fs-3 fw-bold" id="statTotal">0</div>
                                <small>T·ªïng keys</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Export -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-download me-2"></i>Export D·ªØ Li·ªáu</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Xu·∫•t to√†n b·ªô d·ªØ li·ªáu localStorage ra file JSON ƒë·ªÉ backup ho·∫∑c chuy·ªÉn sang tr√¨nh duy·ªát kh√°c.</p>
                        

                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ch·ªçn d·ªØ li·ªáu c·∫ßn export:</label>
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input export-check" type="checkbox" value="products" id="expProducts" checked>
                                        <label class="form-check-label" for="expProducts">S·∫£n ph·∫©m</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-check" type="checkbox" value="accessories" id="expAccessories" checked>
                                        <label class="form-check-label" for="expAccessories">Ph·ª• ki·ªán</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-check" type="checkbox" value="orders" id="expOrders" checked>
                                        <label class="form-check-label" for="expOrders">ƒê∆°n h√†ng</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-check" type="checkbox" value="users" id="expUsers" checked>
                                        <label class="form-check-label" for="expUsers">Users</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-check" type="checkbox" value="customers" id="expCustomers" checked>
                                        <label class="form-check-label" for="expCustomers">Kh√°ch h√†ng</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-check" type="checkbox" value="reviews" id="expReviews" checked>
                                        <label class="form-check-label" for="expReviews">ƒê√°nh gi√°</label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-check">
                                        <input class="form-check-input export-check" type="checkbox" value="banners" id="expBanners" checked>
                                        <label class="form-check-label" for="expBanners">Banners</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-check" type="checkbox" value="categories" id="expCategories" checked>
                                        <label class="form-check-label" for="expCategories">Danh m·ª•c</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-check" type="checkbox" value="brands" id="expBrands" checked>
                                        <label class="form-check-label" for="expBrands">Th∆∞∆°ng hi·ªáu</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-check" type="checkbox" value="vouchers" id="expVouchers" checked>
                                        <label class="form-check-label" for="expVouchers">Vouchers</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input export-check" type="checkbox" value="settings" id="expSettings" checked>
                                        <label class="form-check-label" for="expSettings">C√†i ƒë·∫∑t</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 mb-2">
                            <button class="btn btn-success flex-fill" onclick="exportData()">
                                <i class="fas fa-download me-2"></i>Export JSON
                            </button>
                            <button class="btn btn-outline-success" onclick="selectAllExport(true)">Ch·ªçn t·∫•t c·∫£</button>
                            <button class="btn btn-outline-secondary" onclick="selectAllExport(false)">B·ªè ch·ªçn</button>
                        </div>
                        <button class="btn btn-warning w-100" onclick="exportDataWithImages()" id="btnExportImages">
                            <i class="fas fa-images me-2"></i>Export JSON + ·∫¢nh (Base64)
                        </button>
                        <div id="exportProgress" class="mt-2" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="progressText">ƒêang x·ª≠ l√Ω...</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Import -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Import D·ªØ Li·ªáu</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Nh·∫≠p d·ªØ li·ªáu t·ª´ file JSON ƒë√£ export tr∆∞·ªõc ƒë√≥.</p>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ch·ªçn file JSON:</label>
                            <input type="file" class="form-control" id="importFile" accept=".json">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ch·∫ø ƒë·ªô import:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="importMode" id="modeMerge" value="merge" checked>
                                <label class="form-check-label" for="modeMerge">
                                    <strong>G·ªôp d·ªØ li·ªáu</strong> - Gi·ªØ d·ªØ li·ªáu c≈©, th√™m d·ªØ li·ªáu m·ªõi
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="importMode" id="modeReplace" value="replace">
                                <label class="form-check-label" for="modeReplace">
                                    <strong>Thay th·∫ø</strong> - X√≥a d·ªØ li·ªáu c≈©, d√πng d·ªØ li·ªáu m·ªõi
                                </label>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning py-2">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <small>L∆∞u √Ω: N√™n backup d·ªØ li·ªáu hi·ªán t·∫°i tr∆∞·ªõc khi import!</small>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="importData()">
                            <i class="fas fa-upload me-2"></i>Import D·ªØ Li·ªáu
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Xem tr∆∞·ªõc d·ªØ li·ªáu</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Ch·ªçn key ƒë·ªÉ xem:</label>
                    <select class="form-select" id="previewKey" onchange="previewData()">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="products">products</option>
                        <option value="accessories">accessories</option>
                        <option value="orders">orders</option>
                        <option value="users">users</option>
                        <option value="customers">customers</option>
                        <option value="reviews">reviews</option>
                        <option value="banners">banners</option>
                        <option value="categories">categories</option>
                        <option value="brands">brands</option>
                        <option value="paymentMethods">paymentMethods</option>
                        <option value="vouchers">vouchers</option>
                        <option value="settings">settings</option>
                    </select>
                </div>
                <pre class="data-preview p-3 rounded" id="dataPreview">Ch·ªçn key ƒë·ªÉ xem d·ªØ li·ªáu...</pre>
            </div>
        </div>



        <!-- Danger Zone -->
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>V√πng nguy hi·ªÉm</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><strong>X√≥a to√†n b·ªô d·ªØ li·ªáu</strong></p>
                        <p class="text-muted small">X√≥a t·∫•t c·∫£ d·ªØ li·ªáu trong localStorage. H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
                        <button class="btn btn-outline-danger" onclick="clearAllData()">
                            <i class="fas fa-trash me-2"></i>X√≥a t·∫•t c·∫£
                        </button>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Reset v·ªÅ m·∫∑c ƒë·ªãnh</strong></p>
                        <p class="text-muted small">X√≥a d·ªØ li·ªáu v√† kh√¥i ph·ª•c s·∫£n ph·∫©m m·∫∑c ƒë·ªãnh t·ª´ code.</p>
                        <button class="btn btn-outline-warning" onclick="resetToDefault()">
                            <i class="fas fa-undo me-2"></i>Reset m·∫∑c ƒë·ªãnh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        // Danh s√°ch keys
        const ALL_KEYS = ['products', 'accessories', 'orders', 'users', 'customers', 'reviews', 'banners', 'categories', 'brands', 'paymentMethods', 'vouchers', 'settings'];
        
        // Load th·ªëng k√™
        function loadStats() {
            const getCount = (key) => {
                const data = localStorage.getItem(key);
                if (!data) return 0;
                try {
                    const parsed = JSON.parse(data);
                    return Array.isArray(parsed) ? parsed.length : 1;
                } catch { return 0; }
            };
            
            document.getElementById('statProducts').textContent = getCount('products');
            document.getElementById('statAccessories').textContent = getCount('accessories');
            document.getElementById('statOrders').textContent = getCount('orders');
            document.getElementById('statUsers').textContent = getCount('users');
            document.getElementById('statReviews').textContent = getCount('reviews');
            
            let total = 0;
            ALL_KEYS.forEach(key => { if (localStorage.getItem(key)) total++; });
            document.getElementById('statTotal').textContent = total;
        }
        
        // H√†m chuy·ªÉn ƒë·ªïi URL ·∫£nh th√†nh Base64 s·ª≠ d·ª•ng canvas
        function imageUrlToBase64(url) {
            return new Promise((resolve) => {
                if (!url) {
                    resolve(url);
                    return;
                }
                if (url.startsWith('data:')) {
                    resolve(url);
                    return;
                }
                
                const img = new Image();
                img.crossOrigin = 'anonymous'; // Cho ph√©p CORS
                
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        const base64 = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(base64);
                    } catch (e) {
                        console.warn('Canvas error:', url, e.message);
                        resolve(url); // Gi·ªØ URL g·ªëc n·∫øu l·ªói
                    }
                };
                
                img.onerror = function() {
                    console.warn('Kh√¥ng th·ªÉ t·∫£i ·∫£nh:', url);
                    resolve(url); // Gi·ªØ URL g·ªëc n·∫øu kh√¥ng t·∫£i ƒë∆∞·ª£c
                };
                
                // Th√™m timestamp ƒë·ªÉ bypass cache
                const separator = url.includes('?') ? '&' : '?';
                img.src = url + separator + '_t=' + Date.now();
            });
        }
        
        // Export
        function exportData() {
            const selectedKeys = [];
            document.querySelectorAll('.export-check:checked').forEach(cb => {
                selectedKeys.push(cb.value);
            });
            
            if (selectedKeys.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 lo·∫°i d·ªØ li·ªáu!');
                return;
            }
            
            const exportObj = {
                exportDate: new Date().toISOString(),
                exportDateVN: new Date().toLocaleString('vi-VN'),
                version: '1.0',
                includesImages: false,
                data: {}
            };
            
            selectedKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        exportObj.data[key] = JSON.parse(value);
                    } catch {
                        exportObj.data[key] = value;
                    }
                }
            });
            
            // Th√™m cart c·ªßa users
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('cart_')) {
                    const value = localStorage.getItem(key);
                    if (value) {
                        try {
                            exportObj.data[key] = JSON.parse(value);
                        } catch {
                            exportObj.data[key] = value;
                        }
                    }
                }
            }
            
            // Download
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Export th√†nh c√¥ng! File ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng.');
        }
        
        // Export k√®m ·∫£nh Base64
        async function exportDataWithImages() {
            const selectedKeys = [];
            document.querySelectorAll('.export-check:checked').forEach(cb => {
                selectedKeys.push(cb.value);
            });
            
            if (selectedKeys.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 lo·∫°i d·ªØ li·ªáu!');
                return;
            }
            
            const btn = document.getElementById('btnExportImages');
            const progressDiv = document.getElementById('exportProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang x·ª≠ l√Ω...';
            progressDiv.style.display = 'block';
            
            const exportObj = {
                exportDate: new Date().toISOString(),
                exportDateVN: new Date().toLocaleString('vi-VN'),
                version: '1.0',
                includesImages: true,
                data: {}
            };
            
            // L·∫•y d·ªØ li·ªáu
            selectedKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        exportObj.data[key] = JSON.parse(value);
                    } catch {
                        exportObj.data[key] = value;
                    }
                }
            });
            
            // Th√™m cart c·ªßa users
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('cart_')) {
                    const value = localStorage.getItem(key);
                    if (value) {
                        try {
                            exportObj.data[key] = JSON.parse(value);
                        } catch {
                            exportObj.data[key] = value;
                        }
                    }
                }
            }
            
            // ƒê·∫øm t·ªïng s·ªë ·∫£nh
            let totalImages = 0;
            let processedImages = 0;
            let convertedImages = 0;
            let failedImages = 0;
            
            if (exportObj.data.products) totalImages += exportObj.data.products.length;
            if (exportObj.data.banners) totalImages += exportObj.data.banners.length;
            if (exportObj.data.brands) totalImages += exportObj.data.brands.length;
            
            const updateProgress = (status) => {
                const percent = totalImages > 0 ? Math.round((processedImages / totalImages) * 100) : 0;
                progressBar.style.width = percent + '%';
                progressText.textContent = `${status}: ${processedImages}/${totalImages} (‚úì${convertedImages} ‚úó${failedImages})`;
            };
            
            // H√†m x·ª≠ l√Ω t·ª´ng ·∫£nh v·ªõi timeout v√† CORS proxy
            const processImage = async (url) => {
                if (!url || url.startsWith('data:')) {
                    return { result: url, converted: false };
                }
                
                // Th·ª≠ load ·∫£nh tr·ª±c ti·∫øp tr∆∞·ªõc
                const tryLoadImage = (imgUrl) => {
                    return new Promise((resolve) => {
                        const timeout = setTimeout(() => {
                            resolve({ result: null, converted: false });
                        }, 5000);
                        
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        
                        img.onload = function() {
                            clearTimeout(timeout);
                            try {
                                const canvas = document.createElement('canvas');
                                canvas.width = img.naturalWidth;
                                canvas.height = img.naturalHeight;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);
                                const base64 = canvas.toDataURL('image/jpeg', 0.8);
                                resolve({ result: base64, converted: true });
                            } catch (e) {
                                resolve({ result: null, converted: false });
                            }
                        };
                        
                        img.onerror = function() {
                            clearTimeout(timeout);
                            resolve({ result: null, converted: false });
                        };
                        
                        img.src = imgUrl;
                    });
                };
                
                // Th·ª≠ load tr·ª±c ti·∫øp
                let result = await tryLoadImage(url);
                if (result.converted) {
                    return result;
                }
                
                // Th·ª≠ qua CORS proxy (corsproxy.io)
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
                result = await tryLoadImage(proxyUrl);
                if (result.converted) {
                    return result;
                }
                
                // Th·ª≠ qua CORS proxy kh√°c (api.allorigins.win)
                const proxyUrl2 = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
                result = await tryLoadImage(proxyUrl2);
                if (result.converted) {
                    return result;
                }
                
                // Kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi, gi·ªØ URL g·ªëc
                return { result: url, converted: false };
            };
            
            try {
                // Chuy·ªÉn ƒë·ªïi ·∫£nh products
                if (exportObj.data.products && Array.isArray(exportObj.data.products)) {
                    for (let i = 0; i < exportObj.data.products.length; i++) {
                        if (exportObj.data.products[i].image) {
                            const { result, converted } = await processImage(exportObj.data.products[i].image);
                            exportObj.data.products[i].image = result;
                            if (converted) convertedImages++;
                            else if (exportObj.data.products[i].image && !exportObj.data.products[i].image.startsWith('data:')) failedImages++;
                        }
                        processedImages++;
                        updateProgress('S·∫£n ph·∫©m');
                    }
                }
                
                // Chuy·ªÉn ƒë·ªïi ·∫£nh banners
                if (exportObj.data.banners && Array.isArray(exportObj.data.banners)) {
                    for (let i = 0; i < exportObj.data.banners.length; i++) {
                        if (exportObj.data.banners[i].image) {
                            const { result, converted } = await processImage(exportObj.data.banners[i].image);
                            exportObj.data.banners[i].image = result;
                            if (converted) convertedImages++;
                            else if (exportObj.data.banners[i].image && !exportObj.data.banners[i].image.startsWith('data:')) failedImages++;
                        }
                        processedImages++;
                        updateProgress('Banners');
                    }
                }
                
                // Chuy·ªÉn ƒë·ªïi logo brands
                if (exportObj.data.brands && Array.isArray(exportObj.data.brands)) {
                    for (let i = 0; i < exportObj.data.brands.length; i++) {
                        if (exportObj.data.brands[i].logo) {
                            const { result, converted } = await processImage(exportObj.data.brands[i].logo);
                            exportObj.data.brands[i].logo = result;
                            if (converted) convertedImages++;
                            else if (exportObj.data.brands[i].logo && !exportObj.data.brands[i].logo.startsWith('data:')) failedImages++;
                        }
                        processedImages++;
                        updateProgress('Brands');
                    }
                }
                
                // Download
                const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-with-images-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                progressText.textContent = '‚úÖ Ho√†n th√†nh!';
                
                let message = `‚úÖ Export th√†nh c√¥ng!\n\n`;
                message += `üì¶ T·ªïng: ${totalImages} ·∫£nh\n`;
                message += `‚úì ƒê√£ chuy·ªÉn ƒë·ªïi: ${convertedImages} ·∫£nh\n`;
                if (failedImages > 0) {
                    message += `‚úó Kh√¥ng chuy·ªÉn ƒë∆∞·ª£c (CORS): ${failedImages} ·∫£nh\n\n`;
                    message += `‚ö†Ô∏è ·∫¢nh t·ª´ CDN b√™n ngo√†i (cdn.tgdd.vn) kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi do ch√≠nh s√°ch CORS.\n`;
                    message += `Nh·ªØng ·∫£nh n√†y v·∫´n gi·ªØ URL g·ªëc v√† s·∫Ω hi·ªÉn th·ªã khi c√≥ internet.`;
                }
                
                alert(message);
            } catch (error) {
                alert('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-images me-2"></i>Export JSON + ·∫¢nh (Base64)';
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressBar.classList.add('progress-bar-animated');
                    progressBar.classList.remove('bg-success');
                }, 3000);
            }
        }
        
        // Import
        function importData() {
            const fileInput = document.getElementById('importFile');
            const mode = document.querySelector('input[name="importMode"]:checked').value;
            
            if (!fileInput.files[0]) {
                alert('Vui l√≤ng ch·ªçn file JSON!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importObj = JSON.parse(e.target.result);
                    const data = importObj.data || importObj;
                    
                    let importedCount = 0;
                    
                    Object.keys(data).forEach(key => {
                        if (mode === 'replace') {
                            localStorage.setItem(key, JSON.stringify(data[key]));
                            importedCount++;
                        } else {
                            // Merge mode
                            const existing = localStorage.getItem(key);
                            if (!existing) {
                                localStorage.setItem(key, JSON.stringify(data[key]));
                            } else if (Array.isArray(data[key])) {
                                const existingArr = JSON.parse(existing);
                                const merged = [...existingArr];
                                data[key].forEach(item => {
                                    if (!merged.find(m => m.id === item.id)) {
                                        merged.push(item);
                                    }
                                });
                                localStorage.setItem(key, JSON.stringify(merged));
                            }
                            importedCount++;
                        }
                    });
                    
                    alert(`‚úÖ Import th√†nh c√¥ng! ƒê√£ import ${importedCount} keys.`);
                    loadStats();
                } catch (err) {
                    alert('‚ùå L·ªói: File JSON kh√¥ng h·ª£p l·ªá!\n' + err.message);
                }
            };
            reader.readAsText(fileInput.files[0]);
        }
        
        // Preview
        function previewData() {
            const key = document.getElementById('previewKey').value;
            const preview = document.getElementById('dataPreview');
            
            if (!key) {
                preview.textContent = 'Ch·ªçn key ƒë·ªÉ xem d·ªØ li·ªáu...';
                return;
            }
            
            const data = localStorage.getItem(key);
            if (!data) {
                preview.textContent = `Key "${key}" kh√¥ng c√≥ d·ªØ li·ªáu.`;
                return;
            }
            
            try {
                const parsed = JSON.parse(data);
                preview.textContent = JSON.stringify(parsed, null, 2);
            } catch {
                preview.textContent = data;
            }
        }
        
        // Select all export
        function selectAllExport(checked) {
            document.querySelectorAll('.export-check').forEach(cb => cb.checked = checked);
        }
        
        // Clear all
        function clearAllData() {
            if (!confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA T·∫§T C·∫¢ d·ªØ li·ªáu?\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c!')) return;
            if (!confirm('‚ö†Ô∏è X√ÅC NH·∫¨N L·∫¶N CU·ªêI: X√≥a to√†n b·ªô d·ªØ li·ªáu?')) return;
            
            localStorage.clear();
            alert('‚úÖ ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!');
            loadStats();
        }
        
        // Reset to default
        function resetToDefault() {
            if (!confirm('‚ö†Ô∏è Reset v·ªÅ d·ªØ li·ªáu m·∫∑c ƒë·ªãnh?\n\nD·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã x√≥a!')) return;
            
            localStorage.clear();
            
            // Reload trang ƒë·ªÉ main.js t·ª± ƒë·ªông t·∫°o d·ªØ li·ªáu m·∫∑c ƒë·ªãnh
            alert('‚úÖ ƒê√£ reset! Trang s·∫Ω reload ƒë·ªÉ kh√¥i ph·ª•c d·ªØ li·ªáu m·∫∑c ƒë·ªãnh.');
            location.reload();
        }
        
        // L·∫•y t·∫•t c·∫£ URL ·∫£nh t·ª´ localStorage
        function getAllImageUrls() {
            const urls = new Set();
            
            // L·∫•y ·∫£nh t·ª´ products
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            products.forEach(p => {
                if (p.image) urls.add(p.image);
            });
            
            // L·∫•y ·∫£nh t·ª´ banners
            const banners = JSON.parse(localStorage.getItem('banners') || '[]');
            banners.forEach(b => {
                if (b.image) urls.add(b.image);
            });
            
            // L·∫•y ·∫£nh t·ª´ brands
            const brands = JSON.parse(localStorage.getItem('brands') || '[]');
            brands.forEach(b => {
                if (b.logo) urls.add(b.logo);
            });
            
            // L·∫•y ·∫£nh t·ª´ orders
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            orders.forEach(o => {
                if (o.items) {
                    o.items.forEach(item => {
                        if (item.image) urls.add(item.image);
                    });
                }
            });
            
            return Array.from(urls);
        }
        
        // Hi·ªÉn th·ªã danh s√°ch URL ·∫£nh
        function showImageUrls() {
            const urls = getAllImageUrls();
            const container = document.getElementById('imageUrlsContainer');
            const textarea = document.getElementById('imageUrlsList');
            const countBadge = document.getElementById('imageCount');
            
            container.style.display = 'block';
            textarea.value = urls.join('\n');
            countBadge.textContent = urls.length + ' ·∫£nh';
        }
        
        // Copy t·∫•t c·∫£ URL
        function copyImageUrls() {
            const textarea = document.getElementById('imageUrlsList');
            textarea.select();
            document.execCommand('copy');
            alert('‚úÖ ƒê√£ copy ' + getAllImageUrls().length + ' URL ·∫£nh!');
        }
        
        // Thay th·∫ø ·∫£nh theo ID s·∫£n ph·∫©m
        async function replaceProductImage() {
            const productId = parseInt(document.getElementById('productIdInput').value);
            const fileInput = document.getElementById('singleImageInput');
            
            if (!productId) {
                alert('Vui l√≤ng nh·∫≠p ID s·∫£n ph·∫©m!');
                return;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Vui l√≤ng ch·ªçn file ·∫£nh!');
                return;
            }
            
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const productIndex = products.findIndex(p => p.id === productId);
            
            if (productIndex === -1) {
                alert(`Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m v·ªõi ID: ${productId}`);
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                products[productIndex].image = e.target.result;
                localStorage.setItem('products', JSON.stringify(products));
                
                alert(`‚úÖ ƒê√£ thay th·∫ø ·∫£nh cho s·∫£n ph·∫©m "${products[productIndex].name}" (ID: ${productId})`);
                
                document.getElementById('productIdInput').value = '';
                fileInput.value = '';
            };
            
            reader.readAsDataURL(file);
        }
        
        // T·∫£i danh s√°ch URL ·∫£nh
        function downloadImageList() {
            const urls = getAllImageUrls();
            if (urls.length === 0) {
                alert('Kh√¥ng c√≥ URL ·∫£nh n√†o!');
                return;
            }
            
            let content = '# Danh s√°ch URL ·∫£nh s·∫£n ph·∫©m\n';
            content += '# T·∫£i v·ªÅ: ' + new Date().toLocaleString('vi-VN') + '\n\n';
            
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            
            content += '## S·∫£n ph·∫©m:\n';
            products.forEach(p => {
                if (p.image && !p.image.startsWith('data:')) {
                    content += `ID ${p.id}: ${p.name}\n`;
                    content += `   ${p.image}\n\n`;
                }
            });
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `image-urls-${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ ƒê√£ t·∫£i danh s√°ch ${urls.length} URL ·∫£nh!\n\nB·∫°n c√≥ th·ªÉ d√πng danh s√°ch n√†y ƒë·ªÉ t·∫£i ·∫£nh th·ªß c√¥ng, sau ƒë√≥ upload l·∫°i v√†o h·ªá th·ªëng.`);
        }
        
        // X·ª≠ l√Ω ·∫£nh local t·ª´ m√°y t√≠nh
        async function processLocalImages() {
            const input = document.getElementById('localImagesInput');
            const resultDiv = document.getElementById('localImagesResult');
            const resultText = document.getElementById('localImagesResultText');
            
            if (!input.files || input.files.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 file ·∫£nh!');
                return;
            }
            
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const banners = JSON.parse(localStorage.getItem('banners') || '[]');
            const brands = JSON.parse(localStorage.getItem('brands') || '[]');
            
            let replacedCount = 0;
            
            // Chuy·ªÉn ƒë·ªïi file th√†nh base64
            const fileToBase64 = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => resolve(null);
                    reader.readAsDataURL(file);
                });
            };
            
            // X·ª≠ l√Ω t·ª´ng file
            for (const file of input.files) {
                const base64 = await fileToBase64(file);
                if (!base64) continue;
                
                const fileName = file.name.toLowerCase();
                
                // T√¨m v√† thay th·∫ø trong products
                for (let i = 0; i < products.length; i++) {
                    if (products[i].image && products[i].image.toLowerCase().includes(fileName.replace(/\.[^.]+$/, ''))) {
                        products[i].image = base64;
                        replacedCount++;
                    }
                }
                
                // T√¨m v√† thay th·∫ø trong banners
                for (let i = 0; i < banners.length; i++) {
                    if (banners[i].image && banners[i].image.toLowerCase().includes(fileName.replace(/\.[^.]+$/, ''))) {
                        banners[i].image = base64;
                        replacedCount++;
                    }
                }
                
                // T√¨m v√† thay th·∫ø trong brands
                for (let i = 0; i < brands.length; i++) {
                    if (brands[i].logo && brands[i].logo.toLowerCase().includes(fileName.replace(/\.[^.]+$/, ''))) {
                        brands[i].logo = base64;
                        replacedCount++;
                    }
                }
            }
            
            // L∆∞u l·∫°i v√†o localStorage
            if (replacedCount > 0) {
                localStorage.setItem('products', JSON.stringify(products));
                localStorage.setItem('banners', JSON.stringify(banners));
                localStorage.setItem('brands', JSON.stringify(brands));
            }
            
            resultDiv.style.display = 'block';
            if (replacedCount > 0) {
                resultText.textContent = `ƒê√£ thay th·∫ø ${replacedCount} ·∫£nh th√†nh c√¥ng! B√¢y gi·ªù b·∫°n c√≥ th·ªÉ Export JSON + ·∫¢nh.`;
            } else {
                resultText.textContent = `Kh√¥ng t√¨m th·∫•y ·∫£nh ph√π h·ª£p ƒë·ªÉ thay th·∫ø. H√£y ƒë·∫£m b·∫£o t√™n file ·∫£nh kh·ªõp v·ªõi t√™n trong URL.`;
                resultDiv.querySelector('.alert').classList.remove('alert-success');
                resultDiv.querySelector('.alert').classList.add('alert-warning');
            }
            
            input.value = '';
        }
        
        // Ki·ªÉm tra ·∫£nh c√≤n ho·∫°t ƒë·ªông
        async function checkImageUrls() {
            const urls = getAllImageUrls();
            if (urls.length === 0) {
                alert('Kh√¥ng c√≥ URL ·∫£nh n√†o!');
                return;
            }
            
            const container = document.getElementById('imageUrlsContainer');
            const textarea = document.getElementById('imageUrlsList');
            container.style.display = 'block';
            
            // Ph√¢n lo·∫°i URL
            const cdnUrls = urls.filter(u => u.includes('cdn.tgdd.vn') || u.includes('upload.wikimedia'));
            const otherUrls = urls.filter(u => !u.includes('cdn.tgdd.vn') && !u.includes('upload.wikimedia'));
            
            let result = `üìä Th·ªëng k√™ URL ·∫£nh:\n`;
            result += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            result += `üì¶ T·ªïng s·ªë: ${urls.length} ·∫£nh\n`;
            result += `üåê ·∫¢nh t·ª´ CDN b√™n ngo√†i: ${cdnUrls.length}\n`;
            result += `üìÅ ·∫¢nh kh√°c: ${otherUrls.length}\n\n`;
            
            result += `‚ö†Ô∏è L∆ØU √ù:\n`;
            result += `- ·∫¢nh t·ª´ cdn.tgdd.vn v√† wikimedia l√† URL b√™n ngo√†i\n`;
            result += `- Do ch√≠nh s√°ch CORS, kh√¥ng th·ªÉ ki·ªÉm tra t·ª± ƒë·ªông\n`;
            result += `- ·∫¢nh s·∫Ω hi·ªÉn th·ªã b√¨nh th∆∞·ªùng khi m·ªü trang web\n`;
            result += `- N·∫øu mu·ªën d√πng offline, c·∫ßn t·∫£i ·∫£nh th·ªß c√¥ng\n\n`;
            
            result += `üìã DANH S√ÅCH URL:\n`;
            result += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            urls.forEach((url, i) => {
                result += `${i+1}. ${url}\n`;
            });
            
            textarea.value = result;
            document.getElementById('imageCount').textContent = `${urls.length} URL ·∫£nh`;
        }
        
        // Init
        loadStats();
    </script>
</body>
</html>
